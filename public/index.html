<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Graph Profile Fetcher</title>
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
</head>
<body>
    <h1>Microsoft Graph Profile Fetcher</h1>
    <button id="login">Login with Microsoft</button>
    <pre id="profile"></pre>

    <button id="fetchPeople" style="display:none;">Fetch People Index</button>
    <pre id="peopleIndex"></pre>

    <script>
        const msalConfig = {
            auth: {
                clientId: '23f73785-0f75-43ca-b208-9c9542ed998c',  // Injected from server
                authority: 'https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47',  // Injected from server
                redirectUri: window.location.origin
            }
        };
    
        const msalInstance = new msal.PublicClientApplication(msalConfig);
    
        let account;
    
        document.getElementById('login').addEventListener('click', () => {
            msalInstance.loginPopup({
                scopes: ["user.read","People.Read"]  // Request People.Read permission during login
            }).then(response => {
                console.log('Login response:', response);
                account = response.account;
                msalInstance.setActiveAccount(account);  // Set the active account
                fetchProfile(response.accessToken);
                document.getElementById('fetchPeople').style.display = 'block';  // Show the Fetch People Index button
            }).catch(error => {
                console.error('Login error:', error);
            });
        });
    
        document.getElementById('fetchPeople').addEventListener('click', () => {
            const request = {
                scopes: ["People.Read"],  // Ensure People.Read scope is included
                account: msalInstance.getActiveAccount()  // Use the active account
            };
    
            msalInstance.acquireTokenSilent(request).then(response => {
                fetchPeopleIndex(response.accessToken);
            }).catch(error => {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    // If interaction is required, fall back to interactive token acquisition
                    msalInstance.acquireTokenPopup(request).then(response => {
                        fetchPeopleIndex(response.accessToken);
                    }).catch(popupError => {
                        console.error('Token acquisition via popup failed:', popupError);
                    });
                } else {
                    console.error('Token acquisition error:', error);
                }
            });
        });
    
        function fetchProfile(token) {
            fetch('https://graph.microsoft.com/v1.0/me', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch profile');
                }
                return response.json();
            })
            .then(profile => {
                document.getElementById('profile').innerText = JSON.stringify(profile, null, 2);
            })
            .catch(error => {
                console.error('Error fetching profile:', error);
            });
        }
    
        function fetchPeopleIndex(token) {
            fetch('https://graph.microsoft.com/v1.0/me/people?$top=50&$select=displayName', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch people index');
                }
                return response.json();
            })
            .then(peopleIndex => {
                document.getElementById('peopleIndex').innerText = JSON.stringify(peopleIndex.value, null, 2);
            })
            .catch(error => {
                console.error('Error fetching people index:', error);
            });
        }
    </script>      
</body>
</html>
